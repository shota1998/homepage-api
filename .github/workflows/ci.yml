name: Hompage-api

on:
  pull_request:
    types: [ synchronize ]
    branches: [ "master", "release" ]

env:
  CARGO_TERM_COLOR: always
  DOCKER_COMPOSE_YML: .devcontainer/docker-compose.yml
  CONTAINER_NAME: homepage-api
  REGISTRY: ghcr.io

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        toolchain:
          - stable

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Create an env file
      run: |
        touch .env

        echo DATABASE_URL       = ${{ secrets.DATABASE_URL }}       >> .env
        echo DATABASE_URL_TEST  = ${{ secrets.DATABASE_URL_TEST }}  >> .env

        echo ALLOWED_ORIGIN_1   = ${{ secrets.ALLOWED_ORIGIN_1 }}   >> .env
        echo ALLOWED_ORIGIN_2   = ${{ secrets.ALLOWED_ORIGIN_2 }}   >> .env

        echo LOCAL_FILE_STORAGE = ${{ secrets.LOCAL_FILE_STORAGE }} >> .env

        echo AWS_REGION         = ${{ secrets.AWS_REGIONE }}        >> .env

        echo AWS_BUCKET_TEST    = ${{ secrets.AWS_BUCKET_TEST }}    >> .env
        echo AWS_BUCKET_DEV     = ${{ secrets.AWS_BUCKET_DEV }}     >> .env
        echo AWS_BUCKET         = ${{ secrets.AWS_BUCKET }}         >> .env

        echo AWS_KEY_ID         = ${{ secrets.AWS_KEY_ID }}         >> .env
        echo AWS_KEY_SECRET     = ${{ secrets.AWS_KEY_SECRET }}     >> .env

        echo FILE_STORAGE_LOCATION = ${{ secrets.FILE_STORAGE_LOCATION }} >> .env

        cat .env

    - name: Install Python
      uses: actions/setup-python@v2

    - name: Restore mtime
      run: python ./git-restore-mtime.py

    - name: Cache Rust
      uses: actions/cache@v2
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Setup Rust
      run: rustup update ${{ matrix.toolchain }} && rustup default ${{ matrix.toolchain }}

    - name: Build containers
      run: | 
        docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} up -d
        sleep 5
        docker ps -a

    - name: Build Rust
      run: cargo build --verbose

    # - name: Build app
    #   run: |
    #     docker-compose exec -T ${{ env.CONTAINER_NAME }} cargo build --verbose
    #     docker logs ${{ env.CONTAINER_NAME }} 
      
    - name: Run tests
      run: | 
        docker-compose exec -T ${{ env.CONTAINER_NAME }} cargo test --verbose
        docker logs ${{ env.CONTAINER_NAME }}

# on:
#   merge:
#     branches: [ "master" ]

    # -----------------------
    # Docker
    # -----------------------
    # - name: Set up QEMU
    #   uses: docker/setup-qemu-action@v2

    # - name: Set up Docker Buildx
    #   uses: docker/setup-buildx-action@v2

    # - name: Login to GitHub Container registry
    #   uses: docker/login-action@v2
    #   with:
    #     registry: ${{ env.REGISTRY }}
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}
        
    # - name: Build and push
    #   uses: docker/build-push-action@v3
    #   with:
    #     push: true
    #     context: .
    #     file: ./deploy/Dockerfile
    #     tags: ${{ env.REGISTRY }}/${{ github.actor }}/homepage/api:latest

  # deploy:
  #   meeds: build
  #   runs-on: ubuntu-latest

  #   steps:
        # name: Send docker-compose.yml to a server.
            #todo: Rename docker-compose.yml of remote.
            #todo: Copy docker-compose.yml of git hub.

        # name: Log in to a server.

        # name: Exec docker-compose.yml
            #tood: docer compose down 
            #tood: docer compose up
            #todo: logout

        # test: Get response from api
            # todo: store response code

        # name: Log in to a server.
            #todo: if get 200
                # delete copied docker-comose.yml
            #todo: if get other code
                # docker compose down
                # delete copied docker-comose.yml
                # Rename renamed docker-comose.yml
                # Rename renamed docker-comose.yml
                # docker compose up
            #todo: logout